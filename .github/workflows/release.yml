name: Release Multi-Platform Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            target: 'aarch64-apple-darwin'
            arch: 'Apple Silicon (M1/M2)'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            target: 'x86_64-apple-darwin'
            arch: 'Intel'
          - platform: 'ubuntu-22.04'
            args: '--target x86_64-unknown-linux-gnu'
            target: 'x86_64-unknown-linux-gnu'
            arch: 'x64'
          - platform: 'windows-latest'
            args: '--target x86_64-pc-windows-msvc'
            target: 'x86_64-pc-windows-msvc'
            arch: 'x64'

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.0-dev \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libjavascriptcoregtk-4.1-dev \
            libsoup-3.0-dev \
            libgtk-3-dev

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
          cache-on-failure: true
          shared-key: ${{ matrix.target }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: Install frontend dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Build frontend
        run: npm run build

      - name: Verify build output
        run: |
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ Frontend build failed - dist/index.html not found"
            exit 1
          fi
          echo "âœ… Frontend build successful"
        shell: bash

      - name: Build Tauri application
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'PDF Reader v__VERSION__'
          releaseBody: |
            ## ğŸ‰ PDF Reader ${{ github.ref_name }}
            
            ä¸€ä¸ªåŠŸèƒ½ä¸°å¯Œçš„ç°ä»£ PDF é˜…è¯»å™¨ï¼ŒåŸºäº Vue 3 å’Œ Tauri æ„å»ºã€‚
            
            ### ğŸš€ æ–°ç‰¹æ€§

            - é€‚é…Material3 è®¾è®¡é£æ ¼
            - ä¼˜åŒ–äº†æ€§èƒ½å’Œç¨³å®šæ€§

            ### ğŸ“¦ ä¸‹è½½æŒ‡å—
            
            **é€‰æ‹©é€‚åˆä½ ç³»ç»Ÿçš„ç‰ˆæœ¬ï¼š**
            
            - **ğŸªŸ Windows**: ä¸‹è½½ `.msi` æ–‡ä»¶ï¼ŒåŒå‡»å®‰è£…
            - **ğŸ macOS**: 
              - Intel èŠ¯ç‰‡ Mac: ä¸‹è½½ `x64.dmg`
              - Apple Silicon (M1/M2/M3): ä¸‹è½½ `aarch64.dmg`
            - **ğŸ§ Linux**: 
              - Ubuntu/Debian: ä¸‹è½½ `.deb` æ–‡ä»¶
              - å…¶ä»–å‘è¡Œç‰ˆ: ä¸‹è½½ `.AppImage` æ–‡ä»¶
            
            ### ğŸ“ å®‰è£…è¯´æ˜
            1. ä»ä¸Šæ–¹ Assets ä¸­ä¸‹è½½é€‚åˆä½ ç³»ç»Ÿçš„å®‰è£…åŒ…
            2. Windows: è¿è¡Œ `.msi` æ–‡ä»¶
            3. macOS: æ‰“å¼€ `.dmg` æ–‡ä»¶ï¼Œæ‹–æ‹½åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
            4. Linux: å®‰è£… `.deb` æˆ–ç›´æ¥è¿è¡Œ `.AppImage`
            
            ### ğŸ› é—®é¢˜åé¦ˆ
            å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [GitHub Issues](https://github.com/ZeroHzzzz/PDF-Reader/issues) ä¸­åé¦ˆã€‚
          releaseDraft: false
          prerelease: ${{ contains(github.ref_name, '-beta') || contains(github.ref_name, '-alpha') || contains(github.ref_name, '-rc') }}
          args: ${{ matrix.args }}
