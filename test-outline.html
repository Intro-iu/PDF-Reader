<!DOCTYPE html>
<html>
<head>
    <title>PDF目录测试</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>
<body>
    <h1>PDF目录解析测试</h1>
    <input type="file" id="fileInput" accept=".pdf">
    <div id="output"></div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        document.getElementById('fileInput').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                console.log('PDF加载成功，页数:', pdf.numPages);
                
                // 获取目录
                const outline = await pdf.getOutline();
                console.log('原始目录数据:', outline);
                
                if (outline && outline.length > 0) {
                    const parseOutlineItem = async (item, level = 0) => {
                        let pageNum = 1;
                        
                        if (item.dest) {
                            try {
                                const dest = await pdf.getDestination(item.dest);
                                if (dest && dest[0]) {
                                    const pageRef = dest[0];
                                    const pageIndex = await pdf.getPageIndex(pageRef);
                                    pageNum = pageIndex + 1;
                                }
                            } catch (err) {
                                console.warn('无法获取目录项页面:', err);
                            }
                        }
                        
                        const result = {
                            title: item.title || '无标题',
                            page: pageNum,
                            level
                        };
                        
                        if (item.items && item.items.length > 0) {
                            result.children = [];
                            for (const child of item.items) {
                                const childItem = await parseOutlineItem(child, level + 1);
                                result.children.push(childItem);
                            }
                        }
                        
                        return result;
                    };
                    
                    const processedOutline = [];
                    for (const item of outline) {
                        const outlineItem = await parseOutlineItem(item);
                        processedOutline.push(outlineItem);
                    }
                    
                    console.log('处理后的目录:', processedOutline);
                    
                    // 显示结果
                    const output = document.getElementById('output');
                    output.innerHTML = '<h2>PDF目录:</h2><pre>' + JSON.stringify(processedOutline, null, 2) + '</pre>';
                } else {
                    document.getElementById('output').innerHTML = '<h2>该PDF没有目录</h2>';
                }
                
            } catch (error) {
                console.error('处理PDF时出错:', error);
                document.getElementById('output').innerHTML = '<h2>错误: ' + error.message + '</h2>';
            }
        });
    </script>
</body>
</html>
